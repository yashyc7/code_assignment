<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stripe Django Shop</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        .product-card { transition: transform 0.2s; }
        .product-card:hover { transform: translateY(-5px); box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .order-badge { font-size: 0.9rem; }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-primary mb-4">
        <div class="container">
            <span class="navbar-brand mb-0 h1">üõçÔ∏è Stripe Django Shop</span>
        </div>
    </nav>

    <div class="container">
        {% if messages %}
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endfor %}
        {% endif %}

        <!-- Products Section -->
        <div class="row mb-5">
            <div class="col-12">
                <h2 class="mb-4">Our Products</h2>
            </div>
            {% for product in products %}
            <div class="col-md-4 mb-4">
                <div class="card product-card h-100">
                    <div class="card-body">
                        <h5 class="card-title">{{ product.name }}</h5>
                        <p class="card-text text-muted">{{ product.description }}</p>
                        <p class="h4 text-primary mb-3">${{ product.price }}</p>
                        <div class="input-group mb-3">
                            <input type="number" 
                                   class="form-control quantity-input" 
                                   data-product-id="{{ product.id }}"
                                   min="0" 
                                   max="99" 
                                   value="0" 
                                   placeholder="Qty">
                            <span class="input-group-text">qty</span>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Cart Summary & Checkout -->
        <div class="row mb-5">
            <div class="col-12">
                <div class="card bg-light">
                    <div class="card-body">
                        <h5 class="card-title">Cart Summary</h5>
                        <div id="cart-summary" class="mb-3">
                            <p class="text-muted">Add items to your cart</p>
                        </div>
                        <button id="checkout-button" class="btn btn-success btn-lg" disabled>
                            Proceed to Checkout
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- My Orders Section -->
        {% if paid_orders %}
        <div class="row mb-5">
            <div class="col-12">
                <h2 class="mb-4">My Orders</h2>
            </div>
            {% for order in paid_orders %}
            <div class="col-12 mb-3">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>
                            <strong>Order #{{ order.id }}</strong>
                            <span class="badge bg-success order-badge ms-2">{{ order.status|upper }}</span>
                        </span>
                        <span class="text-muted">{{ order.created_at|date:"M d, Y H:i" }}</span>
                    </div>
                    <div class="card-body">
                        <ul class="list-group list-group-flush">
                            {% for item in order.items.all %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>{{ item.product.name }} √ó {{ item.quantity }}</span>
                                <span class="badge bg-primary rounded-pill">${{ item.subtotal }}</span>
                            </li>
                            {% endfor %}
                        </ul>
                        <div class="mt-3 text-end">
                            <h5>Total: <span class="text-success">${{ order.total_amount }}</span></h5>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const stripe = Stripe('{{ stripe_publishable_key }}');
        const checkoutButton = document.getElementById('checkout-button');
        const cartSummary = document.getElementById('cart-summary');
        const quantityInputs = document.querySelectorAll('.quantity-input');

        // Update cart summary when quantities change
        quantityInputs.forEach(input => {
            input.addEventListener('input', updateCartSummary);
        });

        function updateCartSummary() {
            const items = [];
            let total = 0;
            
            quantityInputs.forEach(input => {
                const quantity = parseInt(input.value) || 0;
                if (quantity > 0) {
                    const card = input.closest('.card');
                    const name = card.querySelector('.card-title').textContent;
                    const price = parseFloat(card.querySelector('.h4').textContent.replace('$', ''));
                    items.push({ name, quantity, price, subtotal: quantity * price });
                    total += quantity * price;
                }
            });

            if (items.length === 0) {
                cartSummary.innerHTML = '<p class="text-muted">Add items to your cart</p>';
                checkoutButton.disabled = true;
            } else {
                let html = '<ul class="list-group mb-3">';
                items.forEach(item => {
                    html += `<li class="list-group-item d-flex justify-content-between">
                        <span>${item.name} √ó ${item.quantity}</span>
                        <span>$${item.subtotal.toFixed(2)}</span>
                    </li>`;
                });
                html += `</ul><h5 class="text-end">Total: <span class="text-success">$${total.toFixed(2)}</span></h5>`;
                cartSummary.innerHTML = html;
                checkoutButton.disabled = false;
            }
        }

        // Handle checkout
        checkoutButton.addEventListener('click', async () => {
            checkoutButton.disabled = true;
            checkoutButton.textContent = 'Processing...';

            const items = [];
            quantityInputs.forEach(input => {
                const quantity = parseInt(input.value) || 0;
                if (quantity > 0) {
                    items.push({
                        product_id: input.dataset.productId,
                        quantity: quantity
                    });
                }
            });

            try {
                const response = await fetch('/create-checkout-session/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ items })
                });

                const data = await response.json();

                if (data.error) {
                    alert('Error: ' + data.error);
                    checkoutButton.disabled = false;
                    checkoutButton.textContent = 'Proceed to Checkout';
                    return;
                }

                // Redirect to Stripe Checkout
                const { error } = await stripe.redirectToCheckout({
                    sessionId: data.sessionId
                });

                if (error) {
                    alert('Error: ' + error.message);
                    checkoutButton.disabled = false;
                    checkoutButton.textContent = 'Proceed to Checkout';
                }
            } catch (error) {
                alert('Error: ' + error.message);
                checkoutButton.disabled = false;
                checkoutButton.textContent = 'Proceed to Checkout';
            }
        });

        // Check for cancelled payment
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('cancelled') === 'true') {
            alert('Payment was cancelled. Your cart is still available.');
        }
    </script>
</body>
</html>